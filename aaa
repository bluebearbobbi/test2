#!/bin/bash

# Usage: ./delete_projects.sh <BASE_URL> <API_TOKEN> <CSV_FILE>
# Example: ./delete_projects.sh https://example.com YOUR_API_TOKEN project_ids.csv
# CSV should have one project ID per line, no headers.

if [ $# -ne 3 ]; then
    echo "Usage: $0 <BASE_URL> <API_TOKEN> <CSV_FILE>"
    exit 1
fi

BASE_URL="$1"
API_TOKEN="$2"
CSV_FILE="$3"

# Fetch bearer token
TOKEN_RESPONSE=$(curl -s -k -X POST "${BASE_URL}/api/tokens/authenticate" \
    -H "Authorization: token ${API_TOKEN}" \
    -H "Accept: application/vnd.blackducksoftware.user-4+json")

BEARER_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.bearerToken')

if [ -z "$BEARER_TOKEN" ] || [ "$BEARER_TOKEN" = "null" ]; then
    echo "Failed to get bearer token: $TOKEN_RESPONSE"
    exit 1
fi

# Delete each project
while read -r PROJECT_ID; do
    if [ -n "$PROJECT_ID" ]; then
        RESPONSE=$(curl -s -k -w "%{http_code}" -X DELETE "${BASE_URL}/api/projects/${PROJECT_ID}" \
            -H "Authorization: Bearer ${BEARER_TOKEN}" \
            -H "Accept: application/json")

        HTTP_CODE=${RESPONSE: -3}
        BODY=${RESPONSE%???}

        if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "Deleted $PROJECT_ID successfully"
        else
            echo "Failed to delete $PROJECT_ID - Code: $HTTP_CODE"
            echo "Details: $BODY"
        fi
    fi
done < "$CSV_FILE"

echo "Process completed."
